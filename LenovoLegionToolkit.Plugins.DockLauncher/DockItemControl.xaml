<UserControl
    x:Class="LenovoLegionToolkit.Plugins.DockLauncher.DockItemControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    Width="64"
    Height="64"
    ClipToBounds="False"
    MouseEnter="UserControl_MouseEnter"
    MouseLeave="UserControl_MouseLeave"
    MouseLeftButtonDown="UserControl_MouseLeftButtonDown"
    MouseRightButtonDown="UserControl_MouseRightButtonDown"
    AllowDrop="True"
    DragEnter="UserControl_DragEnter"
    DragOver="UserControl_DragOver"
    Drop="UserControl_Drop"
    MouseMove="UserControl_MouseMove"
    DragLeave="UserControl_DragLeave">
    <UserControl.Resources>
        <!-- Hover animation - scale up with glow (reduced scale to avoid clipping) -->
        <Storyboard x:Key="HoverAnimation">
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleX"
                To="1.1"
                Duration="0:0:0.15">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleY"
                To="1.1"
                Duration="0:0:0.15">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetName="GlowEffect"
                Storyboard.TargetProperty="Opacity"
                To="0.6"
                Duration="0:0:0.15" />
        </Storyboard>
        
        <!-- Leave animation - scale down -->
        <Storyboard x:Key="LeaveAnimation">
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleX"
                To="1.0"
                Duration="0:0:0.15">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleY"
                To="1.0"
                Duration="0:0:0.15">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetName="GlowEffect"
                Storyboard.TargetProperty="Opacity"
                To="0"
                Duration="0:0:0.15" />
        </Storyboard>
        
        <!-- Bounce animation for app launch -->
        <Storyboard x:Key="BounceAnimation" RepeatBehavior="3x">
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleX"
                From="1.0"
                To="1.4"
                Duration="0:0:0.1"
                AutoReverse="True">
                <DoubleAnimation.EasingFunction>
                    <ElasticEase EasingMode="EaseOut" Oscillations="2" Springiness="3" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleY"
                From="1.0"
                To="1.4"
                Duration="0:0:0.1"
                AutoReverse="True">
                <DoubleAnimation.EasingFunction>
                    <ElasticEase EasingMode="EaseOut" Oscillations="2" Springiness="3" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- Minimize animation - shrink to dock -->
        <Storyboard x:Key="MinimizeAnimation">
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleX"
                From="1.0"
                To="0.3"
                Duration="0:0:0.4">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseIn" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleY"
                From="1.0"
                To="0.3"
                Duration="0:0:0.4">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseIn" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleX"
                To="1.0"
                BeginTime="0:0:0.4"
                Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <ElasticEase EasingMode="EaseOut" Oscillations="1" Springiness="2" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetName="IconScaleTransform"
                Storyboard.TargetProperty="ScaleY"
                To="1.0"
                BeginTime="0:0:0.4"
                Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <ElasticEase EasingMode="EaseOut" Oscillations="1" Springiness="2" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
    </UserControl.Resources>
    
    <Grid x:Name="_mainGrid" RenderTransformOrigin="0.5,1.0" ClipToBounds="False">
        <Grid.RenderTransform>
            <TransformGroup>
                <ScaleTransform x:Name="MainScaleTransform" ScaleX="1.0" ScaleY="1.0" />
                <TranslateTransform x:Name="MainTranslateTransform" Y="0" />
            </TransformGroup>
        </Grid.RenderTransform>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        
        <!-- Glow effect background -->
        <Ellipse
            x:Name="GlowEffect"
            Grid.Row="0"
            Width="64"
            Height="64"
            Opacity="0"
            HorizontalAlignment="Center"
            VerticalAlignment="Center">
            <Ellipse.Fill>
                <RadialGradientBrush>
                    <GradientStop Color="{DynamicResource SystemAccentColor}" Offset="0" />
                    <GradientStop Color="Transparent" Offset="1" />
                </RadialGradientBrush>
            </Ellipse.Fill>
            <Ellipse.Effect>
                <BlurEffect Radius="15" />
            </Ellipse.Effect>
        </Ellipse>
        
        <!-- Icon container with gradient border - allow content to overflow -->
        <Border
            Grid.Row="0"
            x:Name="_iconBorder"
            Width="48"
            Height="48"
            CornerRadius="8"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Cursor="Hand"
            ClipToBounds="False">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#20FFFFFF" Offset="0" />
                    <GradientStop Color="#10FFFFFF" Offset="1" />
                </LinearGradientBrush>
            </Border.Background>
            <Border.BorderBrush>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#40FFFFFF" Offset="0" />
                    <GradientStop Color="#20FFFFFF" Offset="1" />
                </LinearGradientBrush>
            </Border.BorderBrush>
            <Border.BorderThickness>
                <Thickness>1</Thickness>
            </Border.BorderThickness>
            <Border.Effect>
                <DropShadowEffect
                    Color="Black"
                    Direction="270"
                    ShadowDepth="3"
                    Opacity="0.3"
                    BlurRadius="8" />
            </Border.Effect>
            
            <Grid ClipToBounds="False">
                <Image
                    x:Name="_iconImage"
                    Source="{Binding Icon}"
                    Stretch="Uniform"
                    RenderOptions.BitmapScalingMode="Fant"
                    RenderOptions.CachingHint="Cache"
                    RenderOptions.ClearTypeHint="Enabled"
                    UseLayoutRounding="True"
                    SnapsToDevicePixels="True"
                    RenderTransformOrigin="0.5,0.5"
                    ClipToBounds="False">
                    <Image.RenderTransform>
                        <ScaleTransform
                            x:Name="IconScaleTransform"
                            ScaleX="1.0"
                            ScaleY="1.0" />
                    </Image.RenderTransform>
                </Image>
                
                <!-- Stack indicator for multiple windows -->
                <Border
                    x:Name="_stackIndicator"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Background="{DynamicResource SystemAccentColorBrush}"
                    CornerRadius="4"
                    Padding="4,2"
                    Margin="2"
                    Visibility="Collapsed"
                    Panel.ZIndex="10">
                    <TextBlock
                        x:Name="_stackCount"
                        Text="1"
                        FontSize="10"
                        FontWeight="Bold"
                        Foreground="White"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center" />
                </Border>
                
                <!-- Notification badge -->
                <Border
                    x:Name="_notificationBadge"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Background="#FF4444"
                    CornerRadius="8"
                    Padding="4,2"
                    Margin="2"
                    Visibility="Collapsed"
                    MinWidth="16"
                    MinHeight="16"
                    Panel.ZIndex="10">
                    <TextBlock
                        x:Name="_badgeCount"
                        Text=""
                        FontSize="9"
                        FontWeight="Bold"
                        Foreground="White"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        TextAlignment="Center" />
                </Border>
            </Grid>
        </Border>
        
        <!-- Running indicator - macOS style dot with glow, positioned in separate row to always be visible -->
        <Ellipse
            Grid.Row="1"
            HorizontalAlignment="Center"
            VerticalAlignment="Top"
            Width="6"
            Height="6"
            Margin="0,4,0,0"
            x:Name="_runningIndicator"
            Visibility="Collapsed"
            Panel.ZIndex="100">
            <Ellipse.Fill>
                <SolidColorBrush Color="{DynamicResource SystemAccentColor}" />
            </Ellipse.Fill>
            <Ellipse.Effect>
                <DropShadowEffect
                    Color="{DynamicResource SystemAccentColor}"
                    BlurRadius="4"
                    Opacity="0.6"
                    ShadowDepth="0" />
            </Ellipse.Effect>
        </Ellipse>
        
        <!-- Window preview tooltip -->
        <Popup
            x:Name="_previewPopup"
            Placement="Top"
            PlacementTarget="{Binding ElementName=_iconBorder}"
            StaysOpen="True"
            AllowsTransparency="True"
            PopupAnimation="Fade"
            IsOpen="False"
            MouseEnter="PreviewPopup_MouseEnter"
            MouseLeave="PreviewPopup_MouseLeave">
            <Border
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                CornerRadius="8"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                BorderThickness="1"
                Padding="8"
                MaxWidth="200"
                MaxHeight="150">
                <Border.Effect>
                    <DropShadowEffect
                        Color="Black"
                        Direction="270"
                        ShadowDepth="5"
                        Opacity="0.4"
                        BlurRadius="10" />
                </Border.Effect>
                <StackPanel>
                    <TextBlock
                        x:Name="_previewTitle"
                        TextWrapping="Wrap"
                        FontSize="12"
                        FontWeight="Medium"
                        Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                        Margin="0,0,0,4" />
                    <ItemsControl
                        x:Name="_windowPreviewItemsControl"
                        MaxHeight="300">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Background="{DynamicResource ControlFillColorSecondaryBrush}"
                                    CornerRadius="4"
                                    Padding="4"
                                    Margin="2"
                                    Width="180"
                                    Height="120"
                                    MouseLeftButtonDown="WindowThumbnail_MouseLeftButtonDown"
                                    Tag="{Binding}"
                                    Cursor="Hand">
                                    <Border.Effect>
                                        <DropShadowEffect
                                            Color="Black"
                                            Direction="270"
                                            ShadowDepth="2"
                                            Opacity="0.3"
                                            BlurRadius="5" />
                                    </Border.Effect>
                                    <Grid>
                                        <Image
                                            Source="{Binding Thumbnail}"
                                            Stretch="Uniform"
                                            RenderOptions.BitmapScalingMode="HighQuality" />
                                        <TextBlock
                                            Text="{Binding WindowTitle}"
                                            FontSize="10"
                                            Foreground="White"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Bottom"
                                            Margin="4"
                                            TextTrimming="CharacterEllipsis"
                                            Background="#80000000"
                                            Padding="4,2" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </Popup>
    </Grid>
    
    <!-- Context Menu -->
    <UserControl.ContextMenu>
        <ContextMenu x:Name="_contextMenu">
            <MenuItem x:Name="_openMenuItem" Header="打开" Click="OpenMenuItem_Click" />
            <MenuItem x:Name="_showInExplorerMenuItem" Header="在文件资源管理器中显示" Click="ShowInExplorerMenuItem_Click" />
            <Separator />
            <MenuItem x:Name="_optionsMenuItem" Header="选项" Click="OptionsMenuItem_Click" />
            <Separator />
            <MenuItem x:Name="_quitMenuItem" Header="退出" Click="QuitMenuItem_Click" Visibility="Collapsed" />
            <MenuItem x:Name="_removeMenuItem" Header="从 Dock 中移除" Click="RemoveMenuItem_Click" />
        </ContextMenu>
    </UserControl.ContextMenu>
</UserControl>
