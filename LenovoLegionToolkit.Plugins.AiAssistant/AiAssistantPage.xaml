<wpfui:UiPage
    x:Class="LenovoLegionToolkit.Plugins.AiAssistant.AiAssistantPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:wpfui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:plugin="clr-namespace:LenovoLegionToolkit.Plugins.AiAssistant"
    xmlns:conv="clr-namespace:System.Windows.Controls;assembly=PresentationFramework"
    xmlns:converters="clr-namespace:LenovoLegionToolkit.Plugins.AiAssistant.Converters"
    UseLayoutRounding="True"
    SnapsToDevicePixels="True"
    TextOptions.TextFormattingMode="Display"
    TextOptions.TextRenderingMode="Auto"
    FlowDirection="LeftToRight"
    Scrollable="False"
    Loaded="Page_Loaded"
    Unloaded="Page_Unloaded">

    <wpfui:UiPage.Resources>
        <conv:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <plugin:PercentageConverter x:Key="PercentageConverter" />
        <converters:InvertedBooleanToVisibilityConverter x:Key="InvertedBooleanToVisibilityConverter" />
        
        <!-- Welcome Panel Fade Out Animation -->
        <Storyboard x:Key="WelcomeFadeOutAnimation">
            <DoubleAnimation
                Storyboard.TargetName="_welcomePanel"
                Storyboard.TargetProperty="Opacity"
                From="1"
                To="0"
                Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseIn" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- Welcome Panel Fade In Animation -->
        <Storyboard x:Key="WelcomeFadeInAnimation">
            <DoubleAnimation
                Storyboard.TargetName="_welcomePanel"
                Storyboard.TargetProperty="Opacity"
                From="0"
                To="1"
                Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- Message Slide In Animation -->
        <Storyboard x:Key="MessageSlideInAnimation">
            <DoubleAnimation
                Storyboard.TargetProperty="Opacity"
                From="0"
                To="1"
                Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <ThicknessAnimation
                Storyboard.TargetProperty="Margin"
                From="0,20,0,0"
                To="0,0,0,0"
                Duration="0:0:0.3">
                <ThicknessAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </ThicknessAnimation.EasingFunction>
            </ThicknessAnimation>
        </Storyboard>
        
        <!-- Button Hover Animation -->
        <Storyboard x:Key="ButtonHoverAnimation">
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                To="1.05"
                Duration="0:0:0.15">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                To="1.05"
                Duration="0:0:0.15">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- Button Leave Animation -->
        <Storyboard x:Key="ButtonLeaveAnimation">
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                To="1.0"
                Duration="0:0:0.15">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                To="1.0"
                Duration="0:0:0.15">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- Modern Button Styles -->
        <Style x:Key="ModernIconButton" TargetType="wpfui:Button">
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="Margin" Value="4,0" />
            <Setter Property="CornerRadius" Value="8" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}" />
                    <Setter Property="RenderTransform">
                        <Setter.Value>
                            <ScaleTransform ScaleX="1.02" ScaleY="1.02" />
                        </Setter.Value>
                    </Setter>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <!-- Modern TextBox Style -->
        <Style x:Key="ModernTextBox" TargetType="TextBox">
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="BorderThickness" Value="2" />
            <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}" />
            <Setter Property="Background" Value="{DynamicResource ControlFillColorDefaultBrush}" />
            <Style.Triggers>
                <Trigger Property="IsFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColorBrush}" />
                    <Setter Property="BorderThickness" Value="2" />
                </Trigger>
            </Style.Triggers>
        </Style>
    </wpfui:UiPage.Resources>

    <Grid Margin="0,0,16,0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <ScrollViewer 
            x:Name="_contentScrollViewer"
            Grid.Row="0" 
            Grid.RowSpan="2" 
            VerticalScrollBarVisibility="Auto"
            HorizontalScrollBarVisibility="Disabled"
            PanningMode="VerticalOnly">
            <StackPanel Margin="0,0,0,0">
                
                <!-- Header with Description -->
                <StackPanel Margin="0,16,0,24">
                    <TextBlock
                        AutomationProperties.Name="{Binding RelativeSource={RelativeSource Mode=Self}, Path=Text}"
                        Focusable="True"
                        FontSize="24"
                        FontWeight="Medium"
                        Text="{x:Static plugin:Resource.AiAssistant_PageTitle}" />
                    <TextBlock
                        Margin="0,8,0,0"
                        FontSize="14"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        TextWrapping="Wrap"
                        Text="{x:Static plugin:Resource.AiAssistant_PageDescription}"
                        LineHeight="20" />
                </StackPanel>

                <!-- Main Content -->
                <Grid Margin="16">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            
                            <!-- Toolbar - Collapsible -->
                            <Grid Grid.Row="0" Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <!-- Toolbar Toggle Button -->
                                <wpfui:Button
                                    Grid.Column="0"
                                    x:Name="_toolbarToggleButton"
                                    Width="32"
                                    Height="32"
                                    Padding="4"
                                    Margin="0,0,8,0"
                                    Click="ToolbarToggleButton_Click"
                                    Appearance="Secondary"
                                    ToolTip="å±•å¼€/æŠ˜å å·¥å…·æ ">
                                    <TextBlock
                                        FontSize="14"
                                        Text="âš™" />
                                </wpfui:Button>
                                
                                <!-- Toolbar Buttons - Collapsible -->
                                <StackPanel
                                    Grid.Column="1"
                                    x:Name="_toolbarPanel"
                                    Orientation="Horizontal"
                                    Visibility="Collapsed">
                                    <wpfui:Button
                                        x:Name="_clearConversationButton"
                                        HorizontalAlignment="Left"
                                        Margin="0,0,8,0"
                                        Content="{x:Static plugin:Resource.AiAssistant_ClearConversation}"
                                        Click="ClearConversationButton_Click" />
                                    <wpfui:Button
                                        x:Name="_exportHistoryButton"
                                        HorizontalAlignment="Left"
                                        Margin="0,0,8,0"
                                        Content="{x:Static plugin:Resource.AiAssistant_ExportHistory}"
                                        Click="ExportHistoryButton_Click" />
                                </StackPanel>
                                
                                <wpfui:ProgressRing
                                    Grid.Column="3"
                                    IsIndeterminate="True"
                                    Width="20"
                                    Height="20"
                                    Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </Grid>
                            
                            <!-- Main Chat Layout -->
                            <Grid Grid.Row="1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="220" />
                                    <ColumnDefinition Width="12" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                
                                <!-- Sidebar Toggle Button -->
                                <wpfui:Button
                                    Grid.Column="0"
                                    x:Name="_sidebarToggleButton"
                                    Width="32"
                                    Height="32"
                                    Padding="4"
                                    Margin="0,0,8,0"
                                    VerticalAlignment="Top"
                                    HorizontalAlignment="Left"
                                    Click="SidebarToggleButton_Click"
                                    Appearance="Secondary">
                                    <TextBlock
                                        FontSize="16"
                                        Text="â˜°" />
                                </wpfui:Button>
                                
                                <!-- Sessions List (Sidebar) - Collapsible -->
                                <Border
                                    Grid.Column="1"
                                    x:Name="_sidebarPanel"
                                    Background="{DynamicResource ControlFillColorDefaultBrush}"
                                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                    BorderThickness="0,0,1,0"
                                    Padding="16,20"
                                    Visibility="Visible">
                                    <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="16" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="16" />
                                        <RowDefinition Height="*" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    
                                    <!-- AI Assistant Identity -->
                                    <Grid Grid.Row="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <!-- AI Avatar -->
                                        <Border
                                            Grid.Column="0"
                                            Width="32"
                                            Height="32"
                                            CornerRadius="16"
                                            Background="{DynamicResource SystemAccentColorBrush}"
                                            Margin="0,0,8,0"
                                            VerticalAlignment="Center">
                                            <TextBlock
                                                Text="ðŸ¤–"
                                                FontSize="18"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center" />
                                        </Border>
                                        <!-- AI Name -->
                                        <TextBlock
                                            Grid.Column="1"
                                            FontSize="16"
                                            FontWeight="SemiBold"
                                            Foreground="{DynamicResource SystemAccentColorBrush}"
                                            VerticalAlignment="Center">
                                            <TextBlock.Text>
                                                <Binding Path="AiName" RelativeSource="{RelativeSource AncestorType=wpfui:UiPage}" />
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </Grid>
                                    
                                    <!-- New Chat Button -->
                                    <wpfui:Button
                                        Grid.Row="2"
                                        x:Name="_newSessionButton"
                                        Appearance="Secondary"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Left"
                                        Margin="0,0,0,0"
                                        Padding="12,10"
                                        Click="NewSessionButton_Click">
                                        <wpfui:Button.Content>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="+" FontSize="16" FontWeight="Bold" Margin="0,0,8,0" VerticalAlignment="Center" />
                                                <TextBlock Grid.Column="1" Text="å¼€å¯æ–°å¯¹è¯" FontSize="14" VerticalAlignment="Center" />
                                            </Grid>
                                        </wpfui:Button.Content>
                                        <wpfui:Button.Style>
                                            <Style TargetType="wpfui:Button" BasedOn="{StaticResource {x:Type wpfui:Button}}">
                                                <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}" />
                                                <Setter Property="CornerRadius" Value="8" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="{DynamicResource ControlFillColorTertiaryBrush}" />
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </wpfui:Button.Style>
                                    </wpfui:Button>
                                    
                                    <!-- Sessions List (Grouped) -->
                                    <ScrollViewer
                                        Grid.Row="4"
                                        VerticalScrollBarVisibility="Auto"
                                        HorizontalScrollBarVisibility="Disabled">
                                        <ItemsControl ItemsSource="{Binding SessionGroups}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Margin="0,0,0,16">
                                                        <!-- Group Title -->
                                                        <TextBlock
                                                            Text="{Binding GroupName}"
                                                            FontSize="12"
                                                            FontWeight="Medium"
                                                            Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                            Margin="0,0,0,8" />
                                                        <!-- Group Sessions -->
                                                        <ItemsControl ItemsSource="{Binding Sessions}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Grid Margin="0,2">
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="Auto" />
                                                                            <ColumnDefinition Width="*" />
                                                                        </Grid.ColumnDefinitions>
                                                                        <!-- Document Icon -->
                                                                        <TextBlock
                                                                            Grid.Column="0"
                                                                            Text="ðŸ“„"
                                                                            FontSize="14"
                                                                            Margin="0,0,8,0"
                                                                            VerticalAlignment="Center" />
                                                                        <TextBlock 
                                                                            Grid.Column="1"
                                                                            Text="{Binding Title}" 
                                                                            FontSize="14"
                                                                            TextTrimming="CharacterEllipsis"
                                                                            VerticalAlignment="Center"
                                                                            Cursor="Hand"
                                                                            MouseLeftButtonDown="SessionItem_Click">
                                                                            <TextBlock.Style>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Style.Triggers>
                                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                                            <Setter Property="Foreground" Value="{DynamicResource SystemAccentColorBrush}" />
                                                                                        </Trigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </TextBlock.Style>
                                                                        </TextBlock>
                                                                    </Grid>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                    
                                    <!-- User Profile (Bottom) -->
                                    <Grid Grid.Row="5" Margin="0,16,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <!-- User Avatar -->
                                        <Border
                                            Grid.Column="0"
                                            Width="32"
                                            Height="32"
                                            CornerRadius="16"
                                            Background="#4CAF50"
                                            Margin="0,0,8,0"
                                            VerticalAlignment="Center">
                                            <TextBlock
                                                Text="{Binding UserName, StringFormat='{}{0:0}'}"
                                                FontSize="14"
                                                FontWeight="Bold"
                                                Foreground="White"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center" />
                                        </Border>
                                        <!-- User Name -->
                                        <TextBlock
                                            Grid.Column="1"
                                            Text="{Binding UserName}"
                                            FontSize="14"
                                            Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                            VerticalAlignment="Center" />
                                        <!-- Menu Button -->
                                        <wpfui:Button
                                            Grid.Column="2"
                                            Padding="4"
                                            MinWidth="24"
                                            MinHeight="24"
                                            Appearance="Transparent"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Cursor="Hand">
                                            <TextBlock
                                                Text="â‹¯"
                                                FontSize="16"
                                                FontWeight="Bold"
                                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                VerticalAlignment="Center"
                                                HorizontalAlignment="Center" />
                                        </wpfui:Button>
                                    </Grid>
                                    </Grid>
                                </Border>
                                
                                <!-- Chat History -->
                                <ScrollViewer
                                    x:Name="_chatHistoryScrollViewer"
                                    Grid.Column="3"
                                VerticalScrollBarVisibility="Auto"
                                HorizontalScrollBarVisibility="Disabled"
                                Margin="0,0,0,12">
                                <Grid Margin="0,0,16,0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*" />
                                        <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                                    
                                    <!-- Welcome Message (shown when no messages) -->
                                    <StackPanel
                                        x:Name="_welcomePanel"
                                        Grid.Row="0"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Margin="0,0,0,40"
                                        Opacity="1"
                                        RenderTransformOrigin="0.5,0.5">
                                        <StackPanel.RenderTransform>
                                            <ScaleTransform />
                                        </StackPanel.RenderTransform>
                                        <TextBlock
                                            FontSize="32"
                                            FontWeight="Bold"
                                            HorizontalAlignment="Center"
                                            TextAlignment="Center"
                                            Foreground="{DynamicResource TextFillColorPrimaryBrush}">
                                            <Run Text="{Binding GreetingMessage}" />
                                            <Run Text="," />
                                            <Run Text="{Binding UserName}" />
                                        </TextBlock>
                                    </StackPanel>
                                    
                                    <!-- Chat Messages -->
                                    <ItemsControl
                                        Grid.Row="1"
                                        ItemsSource="{Binding ChatHistory}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,0,0,16" Opacity="0">
                                                <Grid.Triggers>
                                                    <EventTrigger RoutedEvent="FrameworkElement.Loaded">
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation
                                                                    Storyboard.TargetProperty="Opacity"
                                                                    From="0"
                                                                    To="1"
                                                                    Duration="0:0:0.3">
                                                                    <DoubleAnimation.EasingFunction>
                                                                        <CubicEase EasingMode="EaseOut" />
                                                                    </DoubleAnimation.EasingFunction>
                                                                </DoubleAnimation>
                                                                <ThicknessAnimation
                                                                    Storyboard.TargetProperty="Margin"
                                                                    From="0,20,0,16"
                                                                    To="0,0,0,16"
                                                                    Duration="0:0:0.3">
                                                                    <ThicknessAnimation.EasingFunction>
                                                                        <CubicEase EasingMode="EaseOut" />
                                                                    </ThicknessAnimation.EasingFunction>
                                                                </ThicknessAnimation>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </EventTrigger>
                                                </Grid.Triggers>
                                                <!-- User Message (Right aligned) -->
                                                <Grid HorizontalAlignment="Right" Margin="0,4,0,0" Visibility="{Binding IsUser, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <Grid.MaxWidth>
                                                        <Binding RelativeSource="{RelativeSource AncestorType=ScrollViewer}" Path="ActualWidth" Converter="{StaticResource PercentageConverter}" ConverterParameter="0.9" />
                                                    </Grid.MaxWidth>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    <Border
                                                        Grid.Column="0"
                                                        Background="{DynamicResource SystemAccentColorBrush}"
                                                        CornerRadius="12,12,4,12"
                                                        Padding="12,10"
                                                        Margin="0,0,12,0">
                                                        <Border.Effect>
                                                            <DropShadowEffect 
                                                                BlurRadius="8" 
                                                                ShadowDepth="2" 
                                                                Opacity="0.2" 
                                                                Color="Black" />
                                                        </Border.Effect>
                                                        <StackPanel>
                                                            <Grid Margin="0,0,0,4">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>
                                                                <TextBlock
                                                                    Grid.Column="0"
                                                                    FontSize="12"
                                                                    FontWeight="Medium"
                                                                    Foreground="White"
                                                                    Text="{x:Static plugin:Resource.AiAssistant_UserMessage}" />
                                                                <wpfui:Button
                                                                    Grid.Column="1"
                                                                    Tag="{Binding}"
                                                                    Padding="4"
                                                                    MinWidth="0"
                                                                    MinHeight="0"
                                                                    Width="24"
                                                                    Height="24"
                                                                    CornerRadius="12"
                                                                    Click="UserMessageMenuButton_Click"
                                                                    Appearance="Transparent"
                                                                    ToolTip="æ›´å¤šé€‰é¡¹">
                                                                    <TextBlock
                                                                        Text="â‹¯"
                                                                        FontSize="16"
                                                                        Foreground="White"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center" />
                                                                </wpfui:Button>
                                                            </Grid>
                                                            <TextBlock
                                                                Text="{Binding Content}"
                                                                TextWrapping="Wrap"
                                                                Foreground="White"
                                                                FontSize="14" />
                                                        </StackPanel>
                                                    </Border>
                                                    <!-- User Avatar -->
                                                    <Border
                                                        Grid.Column="1"
                                                        Width="32"
                                                        Height="32"
                                                        CornerRadius="16"
                                                        Background="{DynamicResource SystemAccentColorBrush}"
                                                        VerticalAlignment="Top">
                                                        <TextBlock
                                                            Text="ðŸ‘¤"
                                                            FontSize="18"
                                                            HorizontalAlignment="Center"
                                                            VerticalAlignment="Center" />
                                                    </Border>
                                                </Grid>
                                                
                                                <!-- AI Message (Left aligned) -->
                                                <Grid HorizontalAlignment="Left" Margin="0,4,0,0">
                                                    <Grid.MaxWidth>
                                                        <Binding RelativeSource="{RelativeSource AncestorType=ScrollViewer}" Path="ActualWidth" Converter="{StaticResource PercentageConverter}" ConverterParameter="0.7" />
                                                    </Grid.MaxWidth>
                                                    <Grid.Style>
                                                        <Style TargetType="Grid">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsUser}" Value="False">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Grid.Style>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <!-- AI Avatar -->
                                                    <Border
                                                        Grid.Column="0"
                                                        Width="32"
                                                        Height="32"
                                                        CornerRadius="16"
                                                        Background="{DynamicResource SystemAccentColorBrush}"
                                                        Margin="0,0,8,0"
                                                        VerticalAlignment="Top"
                                                        HorizontalAlignment="Left">
                                                        <TextBlock
                                                            Text="ðŸ¤–"
                                                            FontSize="18"
                                                            HorizontalAlignment="Center"
                                                            VerticalAlignment="Center" />
                                                    </Border>
                                                    <Border
                                                        Grid.Column="1"
                                                        Background="{DynamicResource ControlFillColorSecondaryBrush}"
                                                        CornerRadius="12,12,12,4"
                                                        Padding="12,10">
                                                        <Border.Effect>
                                                            <DropShadowEffect 
                                                                BlurRadius="8" 
                                                                ShadowDepth="2" 
                                                                Opacity="0.15" 
                                                                Color="Black" />
                                                        </Border.Effect>
                                                        <StackPanel>
                                                            <Grid Margin="0,0,0,4">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>
                                                                <StackPanel Grid.Column="0" Orientation="Horizontal">
                                                                    <TextBlock
                                                                        FontSize="12"
                                                                        FontWeight="Medium"
                                                                        Foreground="{DynamicResource TextFillColorPrimaryBrush}">
                                                                        <TextBlock.Text>
                                                                            <Binding Path="AiName" RelativeSource="{RelativeSource AncestorType=wpfui:UiPage}" />
                                                                        </TextBlock.Text>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        FontSize="10"
                                                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                                        Opacity="0.7"
                                                                        Margin="8,0,0,0"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding FormattedTimestamp}" />
                                                                </StackPanel>
                                                                <wpfui:Button
                                                                    Grid.Column="1"
                                                                    Tag="{Binding}"
                                                                    Padding="4"
                                                                    MinWidth="0"
                                                                    MinHeight="0"
                                                                    Width="24"
                                                                    Height="24"
                                                                    CornerRadius="12"
                                                                    Click="AiMessageMenuButton_Click"
                                                                    Appearance="Transparent"
                                                                    ToolTip="æ›´å¤šé€‰é¡¹">
                                                                    <TextBlock
                                                                        Text="â‹¯"
                                                                        FontSize="16"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center" />
                                                                </wpfui:Button>
                                                            </Grid>
                                                            <TextBlock
                                                                Text="{Binding Content}"
                                                                TextWrapping="Wrap"
                                                                FontSize="14"
                                                                Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                                Visibility="{Binding IsTyping, Converter={StaticResource InvertedBooleanToVisibilityConverter}}" />
                                                            <StackPanel
                                                                Orientation="Horizontal"
                                                                Visibility="{Binding IsTyping, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                                <wpfui:ProgressRing
                                                                    Width="16"
                                                                    Height="16"
                                                                    IsIndeterminate="True"
                                                                    Margin="0,0,8,0" />
                                                                <TextBlock
                                                                    Text="{x:Static plugin:Resource.AiAssistant_AITyping}"
                                                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                                    FontSize="14"
                                                                    FontStyle="Italic" />
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Border>
                                                </Grid>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>
                            </ScrollViewer>
                            </Grid>
                            
                            <!-- Quick Action Buttons - Moved below input area -->
                            <Grid Grid.Row="4" Margin="0,16,0,0">
                                <UniformGrid Columns="7" HorizontalAlignment="Center" MaxWidth="800">
                                    <wpfui:Button
                                        x:Name="_quickWriteButton"
                                        Margin="3"
                                        Padding="10,8"
                                        Width="Auto"
                                        Height="32"
                                        CornerRadius="16"
                                        Content="{x:Static plugin:Resource.AiAssistant_QuickWrite}"
                                        Click="QuickActionButton_Click"
                                        Tag="write"
                                        Appearance="Secondary">
                                        <wpfui:Button.Style>
                                            <Style TargetType="wpfui:Button">
                                                <Setter Property="Background" Value="#4CAF50" />
                                                <Setter Property="Foreground" Value="White" />
                                                <Setter Property="FontSize" Value="11" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#45a049" />
                                                        <Setter Property="RenderTransform">
                                                            <Setter.Value>
                                                                <ScaleTransform ScaleX="1.05" ScaleY="1.05" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </wpfui:Button.Style>
                                    </wpfui:Button>
                                    <wpfui:Button
                                        x:Name="_quickImageButton"
                                        Margin="3"
                                        Padding="10,8"
                                        Width="Auto"
                                        Height="32"
                                        CornerRadius="16"
                                        Content="å›¾åƒç”Ÿæˆ"
                                        Click="QuickActionButton_Click"
                                        Tag="image"
                                        Appearance="Secondary">
                                        <wpfui:Button.Style>
                                            <Style TargetType="wpfui:Button">
                                                <Setter Property="Background" Value="#FF9800" />
                                                <Setter Property="Foreground" Value="White" />
                                                <Setter Property="FontSize" Value="11" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#F57C00" />
                                                        <Setter Property="RenderTransform">
                                                            <Setter.Value>
                                                                <ScaleTransform ScaleX="1.05" ScaleY="1.05" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </wpfui:Button.Style>
                                    </wpfui:Button>
                                    <wpfui:Button
                                        x:Name="_quickVideoButton"
                                        Margin="3"
                                        Padding="10,8"
                                        Width="Auto"
                                        Height="32"
                                        CornerRadius="16"
                                        Content="è§†é¢‘ç”Ÿæˆ"
                                        Click="QuickActionButton_Click"
                                        Tag="video"
                                        Appearance="Secondary">
                                        <wpfui:Button.Style>
                                            <Style TargetType="wpfui:Button">
                                                <Setter Property="Background" Value="#F44336" />
                                                <Setter Property="Foreground" Value="White" />
                                                <Setter Property="FontSize" Value="11" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#D32F2F" />
                                                        <Setter Property="RenderTransform">
                                                            <Setter.Value>
                                                                <ScaleTransform ScaleX="1.05" ScaleY="1.05" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </wpfui:Button.Style>
                                    </wpfui:Button>
                                    <wpfui:Button
                                        x:Name="_quickTranslateButton"
                                        Margin="3"
                                        Padding="10,8"
                                        Width="Auto"
                                        Height="32"
                                        CornerRadius="16"
                                        Content="{x:Static plugin:Resource.AiAssistant_QuickTranslate}"
                                        Click="QuickActionButton_Click"
                                        Tag="translate"
                                        Appearance="Secondary">
                                        <wpfui:Button.Style>
                                            <Style TargetType="wpfui:Button">
                                                <Setter Property="Background" Value="#9C27B0" />
                                                <Setter Property="Foreground" Value="White" />
                                                <Setter Property="FontSize" Value="11" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#7B1FA2" />
                                                        <Setter Property="RenderTransform">
                                                            <Setter.Value>
                                                                <ScaleTransform ScaleX="1.05" ScaleY="1.05" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </wpfui:Button.Style>
                                    </wpfui:Button>
                                    <wpfui:Button
                                        x:Name="_quickCodeButton"
                                        Margin="3"
                                        Padding="10,8"
                                        Width="Auto"
                                        Height="32"
                                        CornerRadius="16"
                                        Content="{x:Static plugin:Resource.AiAssistant_QuickCode}"
                                        Click="QuickActionButton_Click"
                                        Tag="code"
                                        Appearance="Secondary">
                                        <wpfui:Button.Style>
                                            <Style TargetType="wpfui:Button">
                                                <Setter Property="Background" Value="#2196F3" />
                                                <Setter Property="Foreground" Value="White" />
                                                <Setter Property="FontSize" Value="11" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#1976D2" />
                                                        <Setter Property="RenderTransform">
                                                            <Setter.Value>
                                                                <ScaleTransform ScaleX="1.05" ScaleY="1.05" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </wpfui:Button.Style>
                                    </wpfui:Button>
                                    <wpfui:Button
                                        x:Name="_quickSearchButton"
                                        Margin="3"
                                        Padding="10,8"
                                        Width="Auto"
                                        Height="32"
                                        CornerRadius="16"
                                        Content="{x:Static plugin:Resource.AiAssistant_QuickSearch}"
                                        Click="QuickActionButton_Click"
                                        Tag="search"
                                        Appearance="Secondary">
                                        <wpfui:Button.Style>
                                            <Style TargetType="wpfui:Button">
                                                <Setter Property="Background" Value="#3F51B5" />
                                                <Setter Property="Foreground" Value="White" />
                                                <Setter Property="FontSize" Value="11" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#303F9F" />
                                                        <Setter Property="RenderTransform">
                                                            <Setter.Value>
                                                                <ScaleTransform ScaleX="1.05" ScaleY="1.05" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </wpfui:Button.Style>
                                    </wpfui:Button>
                                    <wpfui:Button
                                        x:Name="_quickMoreButton"
                                        Margin="3"
                                        Padding="10,8"
                                        Width="Auto"
                                        Height="32"
                                        CornerRadius="16"
                                        Content="{x:Static plugin:Resource.AiAssistant_QuickMore}"
                                        Click="QuickActionButton_Click"
                                        Tag="more"
                                        Appearance="Secondary">
                                        <wpfui:Button.Style>
                                            <Style TargetType="wpfui:Button">
                                                <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}" />
                                                <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                                                <Setter Property="FontSize" Value="11" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="{DynamicResource ControlFillColorTertiaryBrush}" />
                                                        <Setter Property="RenderTransform">
                                                            <Setter.Value>
                                                                <ScaleTransform ScaleX="1.05" ScaleY="1.05" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </wpfui:Button.Style>
                                    </wpfui:Button>
                                </UniformGrid>
                            </Grid>
                            
                            <!-- Input Area -->
                            <Grid Grid.Row="2" Margin="0,20,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                
                                <!-- Input Box with internal buttons -->
                                <Border
                                    Grid.Column="0"
                                    CornerRadius="20"
                                    BorderThickness="1"
                                    BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                    Background="{DynamicResource ControlFillColorDefaultBrush}"
                                    Padding="0">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="16" ShadowDepth="4" Opacity="0.08" Color="Black" />
                                    </Border.Effect>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="*" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        
                                        <!-- TextBox Area -->
                                        <Grid Grid.Row="0">
                                            <TextBox
                                                x:Name="_chatInputBox"
                                                AcceptsReturn="True"
                                                TextWrapping="Wrap"
                                                VerticalScrollBarVisibility="Auto"
                                                MinHeight="70"
                                                KeyDown="ChatInputBox_KeyDown"
                                                Padding="20,18,20,50"
                                                FontSize="15"
                                                BorderThickness="0"
                                                Background="Transparent"
                                                TextChanged="ChatInputBox_TextChanged">
                                                <TextBox.Style>
                                                    <Style TargetType="TextBox">
                                                        <Style.Triggers>
                                                            <Trigger Property="IsFocused" Value="True">
                                                                <Setter Property="Background" Value="Transparent" />
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBox.Style>
                                            </TextBox>
                                            <TextBlock
                                                x:Name="_chatInputPlaceholder"
                                                IsHitTestVisible="False"
                                                Padding="20,18,20,50"
                                                FontSize="15"
                                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                VerticalAlignment="Top"
                                                Margin="0,18,0,0"
                                                Text="{x:Static plugin:Resource.AiAssistant_SendMessageOrSelectSkill}">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ElementName=_chatInputBox, Path=Text}" Value="">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding ElementName=_chatInputBox, Path=Text}" Value="{x:Null}">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding ElementName=_chatInputBox, Path=IsFocused}" Value="True">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </Grid>
                                        
                                        <!-- Bottom Row: Left buttons (@, Deep Thinking) and Right buttons (Edit, Voice, Send) -->
                                        <Grid Grid.Row="1" Margin="12,0,12,8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- Left Side: Deep Thinking and Internet Search Buttons -->
                                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Left">
                                                <wpfui:Button
                                                    x:Name="_deepThinkingButton"
                                                    Padding="8,6"
                                                    MinWidth="32"
                                                    MinHeight="28"
                                                    CornerRadius="6"
                                                    Margin="0,0,6,0"
                                                    Click="DeepThinkingButton_Click"
                                                    Appearance="Primary"
                                                    Background="{DynamicResource SystemAccentColorBrush}">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>
                                                        <TextBlock
                                                            Grid.Column="0"
                                                            Text="âˆž"
                                                            FontSize="14"
                                                            FontWeight="Bold"
                                                            Foreground="White"
                                                            Margin="0,0,4,0"
                                                            VerticalAlignment="Center" />
                                                        <TextBlock
                                                            Grid.Column="1"
                                                            Text="{x:Static plugin:Resource.AiAssistant_DeepThinking}"
                                                            FontSize="12"
                                                            Foreground="White"
                                                            VerticalAlignment="Center" />
                                                    </Grid>
                                                </wpfui:Button>
                                                <wpfui:Button
                                                    x:Name="_internetSearchButton"
                                                    Padding="8,6"
                                                    MinWidth="32"
                                                    MinHeight="28"
                                                    CornerRadius="6"
                                                    Margin="0,0,0,0"
                                                    Click="InternetSearchButton_Click"
                                                    Appearance="Secondary"
                                                    Background="{DynamicResource ControlFillColorSecondaryBrush}">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>
                                                        <TextBlock
                                                            Grid.Column="0"
                                                            Text="ðŸŒ"
                                                            FontSize="14"
                                                            Margin="0,0,4,0"
                                                            VerticalAlignment="Center" />
                                                        <TextBlock
                                                            Grid.Column="1"
                                                            Text="è”ç½‘æœç´¢"
                                                            FontSize="12"
                                                            Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                            VerticalAlignment="Center" />
                                                    </Grid>
                                                </wpfui:Button>
                                            </StackPanel>
                                            
                                            <!-- Right Side: Send Button -->
                                            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                                <Grid>
                                                    <wpfui:Button
                                                        x:Name="_chatSendButton"
                                                        Padding="8"
                                                        MinWidth="32"
                                                        MinHeight="32"
                                                        CornerRadius="16"
                                                        Click="ChatSendButton_Click"
                                                        Appearance="Primary"
                                                        ToolTip="{x:Static plugin:Resource.AiAssistant_Send}">
                                                        <TextBlock
                                                            x:Name="_sendButtonText"
                                                            FontSize="14"
                                                            Foreground="White"
                                                            Text="â†‘" />
                                                    </wpfui:Button>
                                                    <wpfui:ProgressRing
                                                        x:Name="_sendButtonProgress"
                                                        Width="20"
                                                        Height="20"
                                                        IsIndeterminate="True"
                                                        Visibility="Collapsed"
                                                        VerticalAlignment="Center"
                                                        HorizontalAlignment="Center" />
                                                </Grid>
                                            </StackPanel>
                                        </Grid>
                                    </Grid>
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding ElementName=_chatInputBox, Path=IsFocused}" Value="True">
                                                    <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColorBrush}" />
                                                    <Setter Property="BorderThickness" Value="1.5" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                </Border>
                            </Grid>
                            
                        </Grid>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</wpfui:UiPage>
