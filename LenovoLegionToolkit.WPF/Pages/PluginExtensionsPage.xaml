<wpfui:UiPage
    x:Class="LenovoLegionToolkit.WPF.Pages.PluginExtensionsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:custom="clr-namespace:LenovoLegionToolkit.WPF.Controls.Custom"
    xmlns:resources="clr-namespace:LenovoLegionToolkit.WPF.Resources"
    xmlns:utils="clr-namespace:LenovoLegionToolkit.WPF.Utils"
    xmlns:wpfui="http://schemas.lepo.co/wpfui/2022/xaml"
    x:Name="PluginExtensionsPageRoot"
    FlowDirection="{x:Static utils:LocalizationHelper.Direction}"
    Scrollable="True">
    
<wpfui:UiPage.Resources>
        <!-- Boolean to Visibility Converter -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <utils:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter" />

        <!-- Boolean AND Converter for multiple conditions -->
        <utils:BooleanAndConverter x:Key="BooleanAndConverter" />
        <utils:TextToVisibilityConverter x:Key="TextToVisibilityConverter" />
        
        <!-- List Box Item Style -->
        <Style x:Key="PluginListItemContainerStyle" TargetType="ListBoxItem">
            <Setter Property="Background" Value="{DynamicResource ControlFillColorDefaultBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="MinHeight" Value="90" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Margin" Value="0,0,0,8" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="MainBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="8"
                                Padding="{TemplateBinding Padding}"
                                SnapsToDevicePixels="True">
                            <ContentPresenter />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="MainBorder" Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}" />
                                <Setter TargetName="MainBorder" Property="BorderBrush" Value="{DynamicResource ControlStrokeColorSecondaryBrush}" />
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="MainBorder" Property="Background" Value="{DynamicResource ControlFillColorTertiaryBrush}" />
                                <Setter TargetName="MainBorder" Property="BorderBrush" Value="{DynamicResource SystemAccentColorBrush}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Plugin Icon Style -->
        <Style x:Key="PluginIconStyle" TargetType="Border">
            <Setter Property="Width" Value="48" />
            <Setter Property="Height" Value="48" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="HorizontalAlignment" Value="Left" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Margin" Value="0,0,12,0" />
        </Style>
        
        <!-- Plugin Title Style -->
        <Style x:Key="PluginTitleStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="15" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
        </Style>
        
        <!-- Plugin Version Style -->
        <Style x:Key="PluginVersionStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorSecondaryBrush}" />
            <Setter Property="Margin" Value="0,2,0,0" />
        </Style>
        
        <!-- Plugin Description Style -->
        <Style x:Key="PluginDescriptionStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorTertiaryBrush}" />
            <Setter Property="TextWrapping" Value="Wrap" />
            <Setter Property="MaxHeight" Value="36" />
            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
        </Style>
        
        <!-- Plugin Action Button Style -->
        <Style x:Key="PluginActionButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="70" />
            <Setter Property="Height" Value="28" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="Margin" Value="8,0,0,0" />
            <Setter Property="HorizontalAlignment" Value="Left" />
        </Style>
        
        <!-- Install Button Style (Primary) -->
        <Style x:Key="InstallButtonStyle" TargetType="Button" BasedOn="{StaticResource PluginActionButtonStyle}">
            <Setter Property="HorizontalAlignment" Value="Right" />
        </Style>

        <!-- Plugin List Box Style -->
        <Style x:Key="PluginListBoxStyle" TargetType="ListBox">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled" />
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto" />
        </Style>


    </wpfui:UiPage.Resources>

    <Grid Margin="0,0,16,12">
<Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Title -->
        <StackPanel Grid.Row="0" Margin="0,16,0,24">
            <TextBlock
                x:Name="_titleTextBlock"
                Focusable="True"
                FontSize="24"
                FontWeight="Medium"
                Text="{x:Static resources:Resource.PluginExtensionsPage_Title}" />
            <TextBlock
                x:Name="_descriptionTextBlock"
                Margin="0,8,0,0"
                Focusable="True"
                Text="{x:Static resources:Resource.PluginExtensionsPage_Description}" />
        </StackPanel>



<!-- Search and Filter -->
        <Grid Grid.Row="1" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            
            <wpfui:TextBox
                    x:Name="_searchTextBox"
                    Grid.Column="0"
                    Icon="Search24"
                    PlaceholderText="{x:Static resources:Resource.PluginExtensionsPage_SearchPlaceholder}"
                    TextChanged="SearchTextBox_TextChanged"
                    ClearButtonEnabled="True"
                    Height="36"
                    Margin="0,0,12,0" />
            
                <StackPanel Grid.Column="1" 
                        Orientation="Horizontal" 
                        Margin="12,0,0,0"
                        VerticalAlignment="Center">
                <ComboBox
                    x:Name="_filterComboBox"
                    MinWidth="140"
                    Height="36"
                    SelectionChanged="FilterComboBox_SelectionChanged">
                    <ComboBoxItem Content="{x:Static resources:Resource.PluginExtensionsPage_FilterAll}" Tag="All" IsSelected="True" />
                    <ComboBoxItem Content="{x:Static resources:Resource.PluginExtensionsPage_FilterInstalled}" Tag="Installed" />
                    <ComboBoxItem Content="{x:Static resources:Resource.PluginExtensionsPage_FilterNotInstalled}" Tag="NotInstalled" />
                </ComboBox>
                
                <wpfui:Button
                    x:Name="_bulkImportButton"
                    Icon="Open24"
                    Appearance="Secondary"
                    Margin="8,0,0,0"
                    Height="36"
                    Click="BulkImportButton_Click"
                    ToolTip="{x:Static resources:Resource.PluginExtensionsPage_BulkImportTooltip}" />
                
                <wpfui:Button
                    x:Name="_refreshButton"
                    Icon="ArrowClockwise24"
                    Appearance="Secondary"
                    Margin="8,0,0,0"
                    Height="36"
                    Click="RefreshButton_Click"
                    ToolTip="{x:Static resources:Resource.PluginExtensionsPage_RefreshTooltip}" />

                <wpfui:Button
                    x:Name="_bulkUpdateButton"
                    Icon="ArrowCircleUp24"
                    Appearance="Primary"
                    Margin="8,0,0,0"
                    Height="36"
                    Click="BulkUpdateButton_Click"
                    Visibility="Collapsed"
                    ToolTip="{x:Static resources:Resource.PluginExtensionsPage_UpdateAllTooltip}"
                    Content="{x:Static resources:Resource.PluginExtensionsPage_UpdateAll}" />
            </StackPanel>
        </Grid>

<!-- Deprecation Notice -->
        <wpfui:InfoBar
            x:Name="_deprecationNotice"
            Grid.Row="2"
            Margin="0,0,0,12"
            Severity="Warning"
            IsOpen="False"
            IsClosable="True"
            Title="Toolkit Deprecated"
            Message="The toolkit functionality has been replaced by the plugin system. Please use the Plugin Extensions page to install and manage tools."
            Visibility="Collapsed" />

        <!-- Results Count -->
        <TextBlock
            x:Name="_resultsCountTextBlock"
            Grid.Row="3"
            Margin="0,0,0,12"
            FontSize="12"
            Foreground="{DynamicResource TextFillColorSecondaryBrush}"
            Visibility="Collapsed" />

        <!-- Plugins List -->
        <Grid Grid.Row="4">
            <ListBox x:Name="_pluginsListBox"
                     Style="{StaticResource PluginListBoxStyle}"
                     Padding="0,0,0,24"
                     ClipToBounds="False"
                     SelectionMode="Single"
                     MouseDoubleClick="PluginListBox_MouseDoubleClick"
                     ItemContainerStyle="{StaticResource PluginListItemContainerStyle}">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid MinHeight="90" Background="Transparent">
                            <Grid.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="{x:Static resources:Resource.PluginExtensionsPage_OpenFolder}" Click="ContextMenu_OpenFolder_Click" Tag="{Binding PluginId}">
                                        <MenuItem.Icon>
                                            <wpfui:SymbolIcon Symbol="FolderOpen24" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="{x:Static resources:Resource.PluginExtensionsPage_CopyId}" Click="ContextMenu_CopyId_Click" Tag="{Binding PluginId}">
                                        <MenuItem.Icon>
                                            <wpfui:SymbolIcon Symbol="Copy24" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator />
                                    <MenuItem Header="{x:Static resources:Resource.PluginExtensionsPage_Uninstall}" Click="PluginUninstallButton_Click" Tag="{Binding PluginId}" Visibility="{Binding IsInstalled, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <MenuItem.Icon>
                                            <wpfui:SymbolIcon Symbol="Delete24" Foreground="Red" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </Grid.ContextMenu>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <!-- Plugin Icon -->
                            <Border Grid.Column="0"
                                    Style="{StaticResource PluginIconStyle}"
                                    Background="{Binding IconBackground}">
                                <Grid>
                                    <TextBlock Text="{Binding IconLetter}"
                                               FontSize="18"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource TextOnAccentFillColorPrimaryBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center" />
                                    <!-- Installed Badge -->
                                    <Border Background="{DynamicResource SystemAccentColorBrush}"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Bottom"
                                            Width="18"
                                            Height="18"
                                            CornerRadius="9"
                                            Margin="0,0,-4,-4"
                                            BorderBrush="{DynamicResource ControlFillColorDefaultBrush}"
                                            BorderThickness="2"
                                            Visibility="{Binding IsInstalled, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <wpfui:SymbolIcon Symbol="Checkmark12" 
                                                          FontSize="10" 
                                                          Foreground="{DynamicResource TextOnAccentFillColorPrimaryBrush}" />
                                    </Border>
                                </Grid>
                            </Border>
                            
                            <!-- Plugin Info -->
                            <StackPanel Grid.Column="1" 
                                        Orientation="Vertical" 
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Center"
                                        Margin="0,0,16,0">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Name}"
                                               Style="{StaticResource PluginTitleStyle}" />
                                    <!-- Author -->
                                    <TextBlock Text="{Binding Author, StringFormat='by {0}'}"
                                               FontSize="11"
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                               Margin="8,0,0,0"
                                               VerticalAlignment="Center"
                                               Visibility="{Binding Author, Converter={StaticResource TextToVisibilityConverter}}" />
                                    <!-- Local Badge -->
                                    <Border Background="{DynamicResource SystemAccentColorBrush}"
                                            CornerRadius="4"
                                            Padding="6,2"
                                            Margin="8,0,0,0"
                                            VerticalAlignment="Center"
                                            Visibility="{Binding IsLocal, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock Text="{x:Static resources:Resource.PluginExtensionsPage_LocalBadge}"
                                                   FontSize="10"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextOnAccentFillColorPrimaryBrush}" />
                                    </Border>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Version}"
                                               Style="{StaticResource PluginVersionStyle}" />
                                    
                                    <!-- Update Info Icon -->
                                    <wpfui:Button Icon="Info24"
                                                 Padding="4,0"
                                                 Margin="6,0,0,0"
                                                 Background="Transparent"
                                                 BorderThickness="0"
                                                 FontSize="12"
                                                 Foreground="{DynamicResource SystemAccentColorBrush}"
                                                 Visibility="{Binding UpdateAvailable, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                 ToolTipService.InitialShowDelay="100">
                                        <wpfui:Button.ToolTip>
                                            <ToolTip Background="{DynamicResource ControlFillColorDefaultBrush}"
                                                     BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                                     Padding="12"
                                                     MaxWidth="400">
                                                <StackPanel>
                                                    <TextBlock Text="{x:Static resources:Resource.PluginExtensionsPage_NewVersionAvailable}" 
                                                               FontWeight="Bold" 
                                                               FontSize="14" 
                                                               Margin="0,0,0,8" />
                                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                        <TextBlock Text="{x:Static resources:Resource.PluginExtensionsPage_VersionLabel}" FontWeight="SemiBold" />
                                                        <TextBlock Text="{Binding NewVersion}" />
                                                    </StackPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                                        <TextBlock Text="{x:Static resources:Resource.PluginExtensionsPage_ReleaseDateLabel}" FontWeight="SemiBold" />
                                                        <TextBlock Text="{Binding ReleaseDate}" />
                                                    </StackPanel>
                                                    <TextBlock Text="{x:Static resources:Resource.PluginExtensionsPage_ChangelogLabel}" FontWeight="SemiBold" Margin="0,0,0,4" />
                                                    <TextBlock Text="{Binding Changelog}" 
                                                               TextWrapping="Wrap" 
                                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                                </StackPanel>
                                            </ToolTip>
                                        </wpfui:Button.ToolTip>
                                    </wpfui:Button>
                                </StackPanel>
                                <TextBlock Text="{Binding Location}"
                                           FontSize="11"
                                           Foreground="{DynamicResource SystemAccentColorBrush}"
                                           Margin="0,2,0,0"
                                           Visibility="{Binding Location, Converter={StaticResource TextToVisibilityConverter}}" />
                                <TextBlock Text="{Binding Description}"
                                           Style="{StaticResource PluginDescriptionStyle}"
                                           Margin="0,4,0,0"
                                           Visibility="{Binding IsInstalling, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                                
                                <!-- Installation Progress -->
                                <StackPanel Orientation="Vertical" 
                                            Margin="0,4,0,0"
                                            Visibility="{Binding IsInstalling, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <TextBlock Text="{Binding InstallStatusText}"
                                               FontSize="12"
                                               Foreground="{DynamicResource SystemAccentColorBrush}"
                                               Margin="0,0,0,4" />
                                    <ProgressBar Value="{Binding InstallProgress}"
                                                 Height="4"
                                                 Maximum="100"
                                                 Minimum="0" />
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Action Buttons -->
                            <StackPanel Grid.Column="2" 
                                        Orientation="Horizontal" 
                                        VerticalAlignment="Center"
                                        HorizontalAlignment="Right">
                                <!-- Install/Update Button -->
                                <Button Content="{Binding InstallButtonText}"
                                        Style="{DynamicResource DefaultButtonStyle}"
                                        Width="90"
                                        Height="30"
                                        Click="PluginInstallButton_Click"
                                        Tag="{Binding PluginId}"
                                        Visibility="{Binding ShouldShowInstallButton, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                
                                <!-- Configuration Button -->
                                <Button Content="{Binding ConfigureButtonText}"
                                        Style="{DynamicResource DefaultButtonStyle}"
                                        Width="70"
                                        Height="28"
                                        Margin="8,0,0,0">
                                    <Button.Visibility>
                                        <MultiBinding Converter="{StaticResource BooleanAndConverter}">
                                            <Binding Path="IsInstalled" />
                                            <Binding Path="SupportsConfiguration" />
                                        </MultiBinding>
                                    </Button.Visibility>
                                    <Button.Click>PluginConfigureButton_Click</Button.Click>
                                    <Button.Tag>
                                        <Binding Path="PluginId" />
                                    </Button.Tag>
                                </Button>
                                
                                <!-- Open Button -->
                                <Button Content="{Binding OpenButtonText}"
                                        Style="{DynamicResource DefaultButtonStyle}"
                                        Width="70"
                                        Height="28"
                                        Margin="8,0,0,0"
                                        Visibility="{Binding IsInstalled, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Click="PluginOpenButton_Click"
                                        Tag="{Binding PluginId}" />
                                
                                <!-- Uninstall Button -->
                                <Button Content="{Binding UninstallButtonText}"
                                        Style="{DynamicResource DefaultButtonStyle}"
                                        Width="70"
                                        Height="28"
                                        Margin="8,0,0,0"
                                        Visibility="{Binding IsInstalled, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Click="PluginUninstallButton_Click"
                                        Tag="{Binding PluginId}" />
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <!-- Loading Indicator -->
            <StackPanel
                x:Name="_loadingIndicator"
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                Visibility="Collapsed"
                Margin="24">
                <wpfui:SymbolIcon
                    Symbol="ArrowSync24"
                    FontSize="48"
                    Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                    HorizontalAlignment="Center"
                    Margin="0,0,0,16">
                    <wpfui:SymbolIcon.RenderTransform>
                        <RotateTransform Angle="0" />
                    </wpfui:SymbolIcon.RenderTransform>
                    <wpfui:SymbolIcon.Triggers>
                        <EventTrigger RoutedEvent="Loaded">
                            <BeginStoryboard>
                                <Storyboard>
                                    <DoubleAnimation
                                        Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                        From="0"
                                        To="360"
                                        Duration="0:0:1"
                                        RepeatBehavior="Forever" />
                                </Storyboard>
                            </BeginStoryboard>
                        </EventTrigger>
                    </wpfui:SymbolIcon.Triggers>
                </wpfui:SymbolIcon>
                <TextBlock
                    x:Name="_loadingText"
                    FontSize="16"
                    FontWeight="Medium"
                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                    HorizontalAlignment="Center"
                    TextAlignment="Center" />
            </StackPanel>

            <!-- No Plugins Message -->
            <StackPanel
                x:Name="_noPluginsMessage"
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                Visibility="Collapsed"
                Margin="24">
                <wpfui:SymbolIcon
                    Symbol="Archive24"
                    FontSize="48"
                    Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                    HorizontalAlignment="Center"
                    Margin="0,0,0,16" />
                <TextBlock
                    Text="{x:Static resources:Resource.PluginExtensionsPage_NoPluginsAvailable}"
                    FontSize="16"
                    FontWeight="Medium"
                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                    HorizontalAlignment="Center"
                    TextAlignment="Center" />
                <TextBlock
                    Text="{x:Static resources:Resource.PluginExtensionsPage_EmptyStoreMessage}"
                    FontSize="14"
                    Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                    HorizontalAlignment="Center"
                    TextAlignment="Center"
                    Margin="0,8,0,0" />
            </StackPanel>

            <!-- No Results Message -->
            <StackPanel
                x:Name="_noResultsStackPanel"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Margin="0,64,0,0"
                Visibility="Collapsed">
                <wpfui:SymbolIcon Symbol="SearchVisual24" 
                                  FontSize="48" 
                                  Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                  Margin="0,0,0,16" />
                <TextBlock
                    Text="{x:Static resources:Resource.PluginExtensionsPage_NoResults}"
                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                    FontSize="14"
                    TextAlignment="Center" />
            </StackPanel>
        </Grid>
    </Grid>
</wpfui:UiPage>
